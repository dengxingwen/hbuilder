<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="../../../js/mui.min.js"></script>
		<script src="../../../js/ServerIP.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../js/jquery-2.2.1.js" type="text/javascript" charset="utf-8"></script>
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<!--App自定义的css-->
		<!--<link rel="stylesheet" type="text/css" href="../../../css/app.css" />-->
		<script type="text/javascript" charset="UTF-8">
			mui.init({
				swipeBack: true
			});
			//本地所有学生数据
			var allStudents = {};
			//用于保存设置的学生成绩
			var setStuScoreArr = {};
		</script>
		<style type="text/css">
			.mui-content {
				margin-top: 0px;
				margin-bottom: 45px;
			}
			
			#savaAllScoreButtonDiv {
				position: fixed;
				bottom: 0px;
				left: 0px;
				height: 40px;
				width: 100%;
				background-color: #efeff4;
				z-index: 2;
			}
			
			#savaAllScoreButton {
				width: 100%;
				height: 95%;
			}
		</style>

	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background-color: dodgerblue;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;"></a>
			<h1 class="mui-title" style="color: white;">作业</h1>
		</header>
		<div class="mui-content">
			<div class="mui-card">
				<ul id="namelist" class="mui-table-view">
					<!--这里为填充的内容-->
				</ul>
			</div>
			<div id="savaAllScoreButtonDiv">
				<button id="savaAllScoreButton" type="button" class="mui-btn mui-btn-primary">提交</button>
			</div>
		</div>

		<script type="text/javascript">
			mui.plusReady(function() {
				var allstu = localStorage.stuNameList; //重新转换为对象 
				allStudents = JSON.parse(allstu);
				if (allStudents.length != 0) {
					creatNamePan();
					console.log("创建列表");
				}
				//生成列表
				function creatNamePan() {
					$("#namelist").empty();
					var title = "<li class='mui-table-view-divider'>作业任务评分 满分10分</li>";
					$("#namelist").append(title);
					for (var i = 0; i < allStudents.length; i++) {
						var result = "未评";
						var username = allStudents[i]['username'];
						var stuId = allStudents[i]["stuId"];
						if (!!setStuScoreArr[stuId]) {
							result = setStuScoreArr[stuId];
						} else {
							result = "未评";
						}
						var starScore = 0;
						var nameslistPan = "<li value='" + stuId + "' class='mui-table-view-cell'>" + username + "<span style='width: 70px;text-align: center;position: absolute;right: 10px;color: #999;'>" + result + "分</span></li>";
						$("#namelist").append(nameslistPan);
					}
				};
				//list点击事件
				mui('#namelist').on('tap', 'li', function(e) {
					console.log(this.getAttribute("value"));
					var stuid = this.getAttribute("value")
						//this上下文就是li
					e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
					var btnArray = ['取消', '确定'];
					mui.prompt('请输入评分：', '', '', btnArray, function(e) {
						if (e.index == 1) {
							console.log(e.value);
							if (isNaN(e.value)) {
								return;
							} else {
								//判断是否是0-10之间的数
								if (e.value >= 0 && e.value <= 10) {
									setStuScoreArr[stuid] = e.value;
									console.log(stuid);
									//更新列表中的分数
									creatNamePan();
								} else {
									mui.toast("只能是0-10之间的数字")
									return;
								}
							}
						} else {
							//							info.innerText = '你点了取消按钮';
							console.log("你点了取消按钮");
						}
					})
				});
				//保存所有成绩按钮点击事件
				document.getElementById("savaAllScoreButton").addEventListener('tap', function() {
					mui.ajax(serverIp + "/teacher/savaClassworkScore", {
						data: {
							classworkScore: JSON.stringify(setStuScoreArr)
						},
						dataType: 'json',
						type: 'post',
						timeout: 5000,
						success: function(data) {
							console.log("success");
							console.log(data['code']);
							if (data['code'] == 200) {
								console.log("保存成绩成功");
								mui.toast("保存学生成绩成功");
							} else {
								mui.toast("保存学生成绩失败400");
							}
						},
						error: function() {
							mui.toast("保存学生成绩失败error");
						}
					});
				});
			});
		</script>
	</body>

</html>